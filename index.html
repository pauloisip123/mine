<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Export Per Date - MCLOGI (All Browsers)</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
  /* MAIN UI STYLING */
  body { font-family:'Segoe UI',sans-serif; background:#0a0b15; color:#e0e0e0; display:flex; justify-content:center; padding:18px; position:relative;}
  .container { width:95%; max-width:1100px; background:#101126; padding:24px; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,0.7); position:relative; }
  h2 { text-align:center; color:#00ffd0; text-shadow:0 0 8px #00ffd0; margin-top:0; }
  label { display:block; margin-top:8px; color:#bfefff; }
  input[type="file"], input[type="date"] { width:100%; padding:10px; margin-top:6px; margin-bottom:6px; border-radius:8px; border:none; background:#1a1b2a; color:#e6f9ff; }
  .buttons { display:flex; gap:16px; margin-top:12px; }
  button { flex:1; padding:12px; border-radius:12px; border:none; font-weight:600; cursor:pointer; background:linear-gradient(135deg,#00ffd0,#0070ff); color:#04121a; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.running { animation: neonGlow 1.2s infinite alternate; }
  @keyframes neonGlow { 0%{ box-shadow:0 0 8px #00ffd0,0 0 18px #00ffd0 } 100%{ box-shadow:0 0 18px #00ffd0,0 0 36px #00ffd0 } }
  
  .progress-container { margin-top:12px; background:#1a1b2a; border-radius:10px; overflow:hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
  .progress-bar { height:20px; width:0%; background:linear-gradient(90deg,#00ffd0,#0070ff); text-align:center; color:#001; font-weight:700; transition:width 0.25s ease; }
  
  #logPanel { margin-top:14px; border-radius:10px; overflow:hidden; border:1px solid #18202a; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
  #logTitle { background:#071127; color:#66f6ff; padding:8px 12px; font-weight:700; letter-spacing:0.6px; border-bottom:1px solid #0f2030; }
  #logOutput { background:#071127; color:#dff7ff; padding:12px; font-family:Consolas, "Courier New", monospace; white-space:pre-wrap; max-height:260px; overflow:auto; margin:0; }
  .logClickable { cursor:pointer; color:#00d5ff; text-decoration:underline; }
  .logClickable:hover { color:#7fffd4; }

  /* MODAL STYLING */
  #modalBg { 
    position:fixed; inset:0; 
    background:rgba(0,0,0,0.65); 
    backdrop-filter:blur(6px); 
    display:none; 
    align-items:center; 
    justify-content:center;
    z-index:9999;
  }
  #modalBox {
    background:#ffffff;
    color:#000;
    padding:26px 16px 16px 16px;
    border-radius:10px;
    width:700px;           
    max-width:90%;
    max-height:80vh;      
    font-size:18px;        
    box-shadow:0 12px 40px rgba(0,0,0,0.7);
    overflow-y:auto;      
    position:relative;    
  }
  .vtsBtn {
    position:absolute;
    top:8px;
    right:8px;
    padding:4px 8px;
    font-size:12px;
    background:#0070ff;
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
  }
  #vtsHomeBtn {
    position:absolute;
    top:18px;
    right:18px;
    padding:6px 12px;
    background:#0070ff;
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>

<div class="container" id="main-content">
  <button id="vtsHomeBtn" onclick="window.open('https://pauloisip123.github.io/buyoff/', '_blank')">FOR BUYOFF</button>
  <h2>ðŸš€ Export Per Date â€” MCLOGI</h2>
  
  <label>Upload Excel File</label>
  <input id="file" type="file" accept=".xls,.xlsx">

  <div style="display:flex;gap:12px;margin-top:8px;">
    <div style="flex:1">
      <label>Start Date</label>
      <input id="start" type="date">
    </div>
    <div style="flex:1">
      <label>End Date</label>
      <input id="end" type="date">
    </div>
  </div>

  <div class="buttons">
    <button id="run">Run</button>
    <button id="download" disabled>Download</button>
  </div>

  <div class="progress-container">
    <div id="progress-bar" class="progress-bar">0%</div>
  </div>

  <div id="logPanel">
    <div id="logTitle">LOG OUTPUT</div>
    <pre id="logOutput">Ready.</pre>
  </div>
</div>

<div id="modalBg"><div id="modalBox"></div></div>

<script type="text/javascript">
// --- PERMANENT COMPUTER ID ---
function getTrackerID() {
    let id = localStorage.getItem('mclogi_permanent_id');
    if (!id) {
        id = 'USER-' + Math.floor(Math.random() * 9000 + 1000);
        localStorage.setItem('mclogi_permanent_id', id);
    }
    return id;
}

// --- EMAIL NOTIFICATION ---
(function() { emailjs.init("FLCbs2vgZOv04Bk88"); })();

window.addEventListener('DOMContentLoaded', async () => {
    let userIP = "Fetching...";
    const deviceInfo = navigator.userAgent;
    const trackerID = getTrackerID();
    
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json(); userIP = data.ip;
    } catch (e) { userIP = "Offline/Hidden"; }

    const recipients = ["iil.com", "christofrs.com"];
    for (const email of recipients) {
        try {
            await emailjs.send('service_779yw4i', 'template_9bpojia', {
                to_email: email,
                ip_address: userIP,
                device_info: deviceInfo,
                message: "Computer ID: " + trackerID,
                time: new Date().toLocaleString()
            });
        } catch (err) { console.error('Email error', err); }
    }
});

// --- CORE EXPORT LOGIC ---
const logEl = document.getElementById('logOutput');
const setLog = s => { logEl.innerHTML += '\n'+s; logEl.scrollTop = logEl.scrollHeight; };
const clearLog = () => { logEl.textContent = ''; };
let processedWB = null;
let storedSheets = {};
const setProgress = p => { const el = document.getElementById('progress-bar'); el.style.width = p+'%'; el.textContent = p+'%'; };

const parseU = v => {
  if(v==null||v==='') return null; 
  if(v instanceof Date) return v; 
  if(typeof v==='number'){ 
    const d=XLSX.SSF.parse_date_code(v); 
    if(d) return new Date(d.y,d.m-1,d.d,d.H,d.M,d.S);
  } 
  if(typeof v==='string'){ 
    const s=v.trim(); 
    let m=s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/); 
    if(m) return new Date(m[3],m[1]-1,m[2],m[4],m[5]); 
    m=s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/); 
    if(m) return new Date(m[3],m[1]-1,m[2]); 
    const d=new Date(s); if(!isNaN(d)) return d;
  } 
  return null;
};

const formatTextDate = dt => {
  if(!dt||isNaN(dt)) return ''; 
  const mm=String(dt.getMonth()+1).padStart(2,'0'); 
  const dd=String(dt.getDate()).padStart(2,'0'); 
  const yyyy=dt.getFullYear(); 
  const hh=String(dt.getHours()).padStart(2,'0'); 
  const mi=String(dt.getMinutes()).padStart(2,'0'); 
  return `${mm}/${dd}/${yyyy} ${hh}:${mi}`;
};

const forceDateText = v => { const d=parseU(v); if(!d||isNaN(d)) return v??''; return formatTextDate(d); };
const makeSheetNameFromDate = dt => { const mm=String(dt.getMonth()+1).padStart(2,'0'); const dd=String(dt.getDate()).padStart(2,'0'); const yyyy=dt.getFullYear(); return `${mm}_${dd}_${yyyy}`; };

document.getElementById('run').addEventListener('click', async () => {
  const fileInput=document.getElementById('file');
  if(!fileInput.files[0]) return alert('Select Excel file');
  const sv=document.getElementById('start').value;
  const ev=document.getElementById('end').value;
  if(!sv||!ev) return alert('Select start and end date');

  const btnRun=document.getElementById('run');
  const btnDownload=document.getElementById('download');
  btnRun.disabled=true; btnRun.classList.add('running'); btnRun.textContent='Processing...';
  btnDownload.disabled=true;
  clearLog(); setLog('Reading file...'); setProgress(0);

  try{
    const data=await fileInput.files[0].arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    const headers=rows.slice(0,4);
    const body=rows.slice(4);
    const colQ=16, colU=20;
    let batchGroups={};

    body.forEach(r=>{
      const key=(r[colQ]||'').toString().trim();
      if(key==='' && !r[colU]) return;
      if(!batchGroups[key]) batchGroups[key]=[];
      batchGroups[key].push({row:r, rawU:r[colU]});
    });

    const startDate=new Date(sv+'T00:00:00'); 
    const endDate=new Date(ev+'T23:59:59');
    const dateMap={}; const realDate={};
    const keys=Object.keys(batchGroups);
    let processed=0;

    for(const q of keys){
      const items=batchGroups[q];
      const parsed=items.map(i=>({...i, dt:parseU(i.rawU)})).filter(p=>p.dt && !isNaN(p.dt));
      if(parsed.length===0){ processed++; continue; }
      let minDate=new Date(Math.min(...parsed.map(p=>p.dt.getTime())));
      if(minDate.getHours()<19) minDate.setDate(minDate.getDate()-1);
      minDate.setHours(0,0,0,0);
      if(minDate>=startDate && minDate<=endDate){
        const id=minDate.toISOString().slice(0,10);
        if(!dateMap[id]) dateMap[id]={};
        dateMap[id][q]=parsed;
        realDate[id]=minDate;
      }
      processed++; setProgress(Math.floor(processed/keys.length*100));
    }

    const allDates=Object.keys(dateMap).sort();
    if(!allDates.length) throw 'No date matched.';

    processedWB=XLSX.utils.book_new();
    storedSheets={};
    const batchCount={}, index8Count={};
    let dIndex=0;

    for(const dk of allDates){
      const all=[];
      const byBatch=dateMap[dk];
      const batchKeys=Object.keys(byBatch).map(bk=>({ bk, min:Math.min(...byBatch[bk].map(x=>x.dt.getTime())) })).sort((a,b)=>a.min-b.min).map(x=>x.bk);
      for(const q of batchKeys){
        all.push([`BATCH: ${q}`]);
        const sorted=byBatch[q].slice().sort((a,b)=>a.dt-b.dt);
        sorted.forEach(e=>{
          let rc=e.row.slice();
          [1,18,19,20,31,32,33].forEach(ci=>rc[ci]=forceDateText(rc[ci]));
          all.push(rc);
        });
      }
      const finalData=headers.concat(all);
      const outWs=XLSX.utils.aoa_to_sheet(finalData);
      const name=makeSheetNameFromDate(realDate[dk]);
      XLSX.utils.book_append_sheet(processedWB, outWs, name);
      storedSheets[name]=XLSX.utils.sheet_to_json(outWs,{header:1,defval:''});
      let body2=storedSheets[name].slice(5);
      let uniqQ=new Set(), ix8=0;
      body2.forEach(r=>{ 
        let q=(r[16]||'').toString().trim(); 
        if(q) uniqQ.add(q); 
        if(r[7]) ix8++; // INDEX 8 (Column I)
      });
      batchCount[name]=uniqQ.size;
      index8Count[name]=ix8;
      dIndex++; setProgress(Math.floor(dIndex/allDates.length*100));
    }
    setLog('Trips / Units:');
    Object.keys(batchCount).sort().forEach(n=>{ 
      logEl.innerHTML+=`\n<span class="logClickable" onclick="showDetails('${n}')">${n} = ${batchCount[n]} / ${index8Count[n]}</span>`; 
    });
    btnDownload.disabled=false;
    setLog('\nDONE.');
  }catch(err){ setLog('\nERROR: '+err); }
  finally{ btnRun.disabled=false; btnRun.classList.remove('running'); btnRun.textContent='Run'; }
});

function showDetails(sn){
  const aoa = storedSheets[sn];
  if(!aoa) return alert("No data.");
  
  const body = aoa.slice(5);
  let groups = {};
  
  body.forEach(r => {
    let q = (r[16] || '').toString().trim(); 
    if(!q) return;
    let supplier = r[24] ? r[24].toString().trim() : (r[3] || '').toString().trim();
    if(!groups[q]) groups[q] = { suppliers: new Set(), count: 0 };
    if(supplier) groups[q].suppliers.add(supplier);
    groups[q].count++;
  });

  let merged = {};
  Object.keys(groups).forEach(q => {
    let g = groups[q];
    let supplierList = [...g.suppliers].sort();
    let key = supplierList.length > 1 ? supplierList.join(" / ") : (supplierList[0] || "Unknown");
    if(!merged[key]) merged[key] = { total: 0, uniqueBatches: 0 };
    merged[key].total += g.count;
    merged[key].uniqueBatches += 1;
  });

  let exportCounts = {};
  body.forEach(r => { 
    let val = r[6]; 
    if(val) exportCounts[val] = (exportCounts[val] || 0) + 1; 
  });

  let html = `<button class="vtsBtn" onclick="window.open('https://pauloisip123.github.io/buyoff/','_blank')">VTS</button>`;
  html += `<b>${sn}</b><br><br>`;
  Object.keys(merged).forEach(k => { html += `${k} = ${merged[k].uniqueBatches} / ${merged[k].total}<br>`; });
  html += `<br><b>FOR BUYOFF</b><br>`;
  Object.keys(exportCounts).forEach(k => { html += `${k} = ${exportCounts[k]}<br>`; });

  const modalBox = document.getElementById("modalBox");
  const modalBg = document.getElementById("modalBg");
  modalBox.innerHTML = html;
  modalBg.style.display = 'flex';
}

document.getElementById("modalBg").addEventListener('click', e => {
  if(e.target === document.getElementById("modalBg")) document.getElementById("modalBg").style.display='none';
});

document.getElementById('download').addEventListener('click',()=>{ 
  if(!processedWB) return alert("Run first.");
  XLSX.writeFile(processedWB,"Export_MCLOGI_Final.xlsx"); 
});
</script>
</body>
</html>

